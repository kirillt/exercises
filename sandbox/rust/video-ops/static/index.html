<!doctype html>
<html lang="en">

    <head>
        <meta charset="utf-8">
        <title>Video OPs</title>
        <style>
            html, body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                overflow: hidden;
            }

            #outer-container {
                width: 880px;
                height: 673px;

                position: fixed;
                top:0; bottom:0;
                right:0; left:0;
                margin: auto;
            }

            #inner-container {
                width: 640px;
                height: 568px;

                top:0; bottom:0;
                right:0; left:0;
                margin: auto;
            }
        </style>
    </head>

    <body>
        <video hidden id="video" loop="false" preload>
            <source src="benchmark.mp4" type="video/mp4">
        </video>

        <div id="outer-container">
            <table>
                <tr>
                    <td>
                        <fieldset style="width: 120px">
                            <legend>select mode</legend>

                            <div>
                                <input type="radio" id="filters_wasm" name="mode" checked>
                                <label for="filters_wasm">Rust (WASM)</label>
                            </div>

                            <div>
                                <input type="radio" id="filters_js" name="mode">
                                <label for="filters_js">JavaScript</label>
                            </div>
                        </fieldset>
                    </td>
                    <td>
                        <div class="form">
                            <input type="file" id="selector">
                        </div>

                        <p style="text-align: center; font-family:'Lucida Console', monospace; font-size:9pt">
                            top bar is range selector: drag mouse for specifying time range to play</p>

                        <div id="inner-container">
                            <canvas id="region_tl" width="640" height="32">
                            </canvas>

                                        <canvas id="player" width="640" height="480">
                                        </canvas>

                            <canvas id="playback_tl" width="640" height="32">
                            </canvas>
                        </div>

                        <p style="text-align: center; font-family:'Lucida Console', monospace; font-size:9pt">
                            bottom bar is playback indicator, you can click it to rewind selected range</p>

                        <p style="text-align: center; font-family:'Lucida Console', monospace; font-size:12pt">
                            use [SPACE] for start/stop playback
                        </p>
                    </td>
                    <td>
                        <fieldset style="width: 120px">
                            <legend>select filter</legend>

                            <div>
                                <input type="radio" id="normal" name="filter" checked>
                                <label for="normal">normal</label>
                            </div>
                            <div>
                                <input type="radio" id="grayscale" name="filter">
                                <label for="grayscale">grayscale</label>
                            </div>
                            <div>
                                <input type="radio" id="negative" name="filter">
                                <label for="negative">negative</label>
                            </div>

                            <div>
                                <input type="radio" id="sunset" name="filter">
                                <label for="sunset">sunset</label>
                            </div>
                            <div>
                                <input type="radio" id="longhorn" name="filter">
                                <label for="longhorn">longhorn</label>
                            </div>
                            <div>
                                <input type="radio" id="forest" name="filter">
                                <label for="forest">forest</label>
                            </div>

                            <div>
                                <input type="radio" id="blur" name="filter">
                                <label for="blur">blur</label>
                            </div>
                            <div>
                                <input type="radio" id="good_morning" name="filter">
                                <label for="good_morning">good morning</label>
                            </div>
                        </fieldset>

                        <table style="width: 160px">
                            <tr>
                                <td>
                                    <p style="text-align: left; font-family:'Lucida Console', monospace; font-size:9pt">
                                        Filtering time</p>
                                </td>
                                <td>
                                    <p id="filter_time" style="text-align: right; font-family:'Lucida Console', monospace; font-size:9pt"></p>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <p style="text-align: left; font-family:'Lucida Console', monospace; font-size:9pt">
                                        Drawing time</p>
                                </td>
                                <td>
                                    <p id="draw_time" style="text-align: right; font-family:'Lucida Console', monospace; font-size:9pt"></p>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <p style="text-align: left; font-family:'Lucida Console', monospace; font-size:9pt">
                                        FPS</p>
                                </td>
                                <td>
                                    <p id="fps" style="text-align: right; font-family:'Lucida Console', monospace; font-size:9pt"></p>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>
        </div>

        <script src="video-ops.js"></script>
        <script src="filters.js"></script>
        <script>
            let region_from = -1.0;
            let region_to = -1.0;


            let video = document.getElementById("video");

            window.onkeypress = function(event) {
                if (event.key === ' ') {
                    console.log("[SPACE] pressed");
                    if (video.paused) {
                        video.play();
                    } else {
                        video.pause();
                    }
                }
            };

            let selector = document.getElementById("selector");

            selector.onclick = function() {
                video.pause();
            };

            selector.onchange = function() {
                video.src = URL.createObjectURL(selector.files[0]);
                video.load();
            };


            let player = document.getElementById("player");
            let frame = player.getContext("2d");

            let fieldFT = document.getElementById("filter_time");
            let fieldDT = document.getElementById("draw_time");
            let fieldFPS = document.getElementById("fps");

            let framesDrawed = 0;
            let filterTime = 0;
            let drawTime = 0;

            let filtersWasm = document.getElementById("filters_wasm");
            let filtersJs = document.getElementById("filters_js");

            let filterNormal = document.getElementById("normal");
            let filterGrayscale = document.getElementById("grayscale");
            let filterNegative = document.getElementById("negative");
            let filterSunset = document.getElementById("sunset");
            let filterLonghorn = document.getElementById("longhorn");
            let filterForest = document.getElementById("forest");
            let filterBlur = document.getElementById("blur");
            let filterGoodMorning = document.getElementById("good_morning");

            function draw() {
                const drawStart = performance.now();

                frame.drawImage(video, 0.0, 0.0);

                let filters;
                if (filtersWasm.checked) {
                    filters = window.wasm;
                } else if (filtersJs.checked) {
                    filters = window.js;
                } else {
                    console.error("invalid mode");
                }

                if (!filterNormal.checked) {
                    let width = video.videoWidth;
                    let height = video.videoHeight;
                    let image = frame.getImageData(0.0, 0.0, width, video.videoHeight);
                    let pixels = new Uint8Array(image.data);

                    let result;

                    let filterStart = performance.now();
                    if (filterGrayscale.checked) {
                        result = filters.grayscale(pixels);
                    } else if (filterNegative.checked) {
                        result = filters.negative(pixels);
                    } else if (filterSunset.checked) {
                        result = filters.sunset(pixels, width);
                    } else if (filterLonghorn.checked) {
                        result = filters.longhorn(pixels, width);
                    } else if (filterForest.checked) {
                        result = filters.forest(pixels, width);
                    } else if (filterBlur.checked) {
                        result = filters.blur(pixels, width, height);
                    } else if (filterGoodMorning.checked) {
                        result = filters.goodMorning(pixels, width, height);
                    } else {
                        console.error("invalid filter")
                    }
                    filterTime += (performance.now() - filterStart);

                    image.data.set(result);
                    frame.putImageData(image, 0.0, 0.0);
                } else {
                    filterTime = "off";
                }

                drawTime += (performance.now() - drawStart);

                framesDrawed += 1;

                if (!video.paused) {
                    window.requestAnimationFrame(draw);
                }
            }

            video.onplay = draw;
            video.oncanplay = draw;

            video.ontimeupdate = function() {
                let time = video.currentTime;
                if (time < region_from) {
                    console.error(`Time is before selected region: should be ${region_from} <= ${time}`);
                } else
                if (time > region_to) {
                    video.currentTime = region_from + 0.001;
                } else {
                    let length = region_to - region_from;
                    window.wasm.track((time - region_from) / length);
                }

                if (video.paused) {
                    draw();
                }
            };

            window.setInterval(function() {
                if (video.paused) {
                    fieldDT.innerText = "";
                    fieldFT.innerText = "";
                    fieldFPS.innerText = "";
                    return;
                }

                fieldDT.innerText = (drawTime / framesDrawed).toString().slice(0, 3) + "ms";

                if (filterTime !== "off") {
                    fieldFT.innerText = (filterTime / framesDrawed).toString().slice(0, 3) + "ms";
                } else {
                    fieldFT.innerText = "off";
                }

                fieldFPS.innerText = framesDrawed.toString().slice(0, 3);

                framesDrawed = 0;
                filterTime = 0;
                drawTime = 0;
            }, 1000);

        </script>
    </body>

</html>
